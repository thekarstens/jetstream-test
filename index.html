<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Apr 2018 Case Study – Radar + Alerts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./leaflet.css"/>
<script src="./leaflet.js">
var storyStarted = false; // do not auto-open storyboard
</script>

<style>
html, body { height:100%; margin:0; }
  #map { height:100%; background:#fff; }

  /* Top TV-style banner */
  .tvbanner{
    position:absolute; top:0; left:0; right:0;
    z-index:99999;
    background:rgba(11,28,45,0.94);
    color:#fff;
    font:900 26px/1.1 Arial, sans-serif;
    letter-spacing:0.8px;
    padding:14px 18px;
    border-bottom:2px solid rgba(255,255,255,0.12);
    text-transform:uppercase;
    pointer-events:none;
  }

  .panel{
    position:absolute; top:70px; left:10px; z-index:9999;
    background:rgba(255,255,255,0.95);
    border:1px solid #ccc; border-radius:14px;
    padding:12px;
    font:700 12px/1.2 Arial, sans-serif;
    box-shadow: 0 2px 10px rgba(0,0,0,.10);
    min-width: 340px;
  }
  .row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .btn{
    border:1px solid #333; background:#fff; border-radius:12px;
    padding:6px 10px; cursor:pointer; font:800 12px Arial;
  }
  .btn:active{ transform: translateY(1px); }
  .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-weight:900; }
  .tiny { font:700 11px/1.2 Arial, sans-serif; opacity:.78; }

  /* Branding logo (bottom-right, small) */
  #brandLogo{
    position:absolute;
    bottom:6px;
    right:10px;
    z-index:100000;
    width:140px;
    max-width:24vw;
    height:auto;
    opacity:0.95;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
    pointer-events:none;
  }

  /* Leaflet layer control nudge down below banner */
  .leaflet-top.leaflet-right { top: 70px; }

  /* Simple town label style */
  .town-label{
    background: rgba(255,255,255,0.75);
    border:1px solid rgba(0,0,0,0.25);
    padding:2px 6px;
    border-radius:10px;
    font:800 11px/1 Arial, sans-serif;
    box-shadow: 0 1px 4px rgba(0,0,0,.15);
  }

/* --- Banner layout + controls --- */
.tvbanner{height:76px;padding:10px 14px;pointer-events:auto;}
.banner-inner{height:100%;display:flex;align-items:center;gap:16px;}
.banner-title{font-size:34px;font-weight:900;letter-spacing:1px;white-space:nowrap;text-transform:uppercase;}
.banner-controls{display:flex;align-items:center;gap:10px;margin-left:10px;}
.bbtn{pointer-events:auto;border:1px solid rgba(255,255,255,0.35);background:rgba(0,0,0,0.25);color:#fff;
  padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer;line-height:1;}
.bbtn:hover{background:rgba(0,0,0,0.4);}
.btime{min-width:190px;text-align:center;font-weight:800;letter-spacing:.2px;}
.bsep{width:1px;height:26px;background:rgba(255,255,255,0.25);margin:0 4px;}

  .bzoom{font-weight:800;letter-spacing:.06em;color:#fff;opacity:.92;margin-right:8px}
.banner-actions{margin-left:auto;display:flex;align-items:center;gap:10px;}
.bstatus{margin-left:14px;white-space:nowrap;max-width:320px;overflow:hidden;text-overflow:ellipsis;
  font:800 12px/1 Arial, sans-serif;opacity:.9;}
#brandLogo{
  position:absolute;right:18px;bottom:6px;width:210px;z-index:900;pointer-events:none;
  filter: drop-shadow(0 3px 10px rgba(0,0,0,.35));
}


  /* --- layout tweaks --- */
  .leaflet-top.leaflet-right { margin-top: 90px; }   /* push layer toggles below banner */
  #brandLogo { bottom: 26px; right: 26px; }          /* nudge logo down a bit */


  /* --- Story panel (Google Sheet driven) --- */
  #storyPanel{
    position:absolute;
    top:90px;
    left:10px;
    width:390px;
    max-width:86vw;
    max-height: calc(100vh - 90px);
    overflow:auto;
    z-index:100001;
    background:rgba(255,255,255,0.97);
    border:1px solid rgba(0,0,0,0.18);
    border-radius:16px;
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
    padding:12px 12px 10px 12px;
    transform: translateX(-110%);
    transition: transform 180ms ease;
  }
  #storyPanel.story-open{ transform: translateX(0); }
  .story-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .story-title{ font:900 16px/1.15 Arial, sans-serif; letter-spacing:.2px; }
  .story-close{
    border:1px solid rgba(0,0,0,.25);
    background:#fff;
    border-radius:10px;
    padding:4px 8px;
    font-weight:900;
    cursor:pointer;
  }
  .story-body{ margin-top:10px; font:700 13px/1.35 Arial, sans-serif; color:#111; }
  .story-body p{ margin:0 0 10px 0; }
  .story-media{ margin-top:10px; }
  .story-media img{ width:100%; border-radius:12px; border:1px solid rgba(0,0,0,0.12); }
  .story-media iframe{ width:100%; aspect-ratio: 16/9; border:0; border-radius:12px; }
  .story-nav{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; }
  .story-nav .btn{ flex:1; }
  #storyStep{ margin-top:8px; }
  /* Small story "stations" */
  .story-dot{
    width:10px;height:10px;border-radius:50%;
    background:rgba(30,136,229,0.95);
    border:2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.25);
  }


/* --- Student/Teacher mode --- */
body.student-mode .leaflet-control-layers,
body.student-mode .bstatus { display:none !important; }

/* --- Banner: simple classroom layout --- */
.tvbanner{height:auto; padding:10px 14px; pointer-events:auto;}
.banner-inner{display:flex; align-items:center; gap:14px;}
.banner-left{display:flex; align-items:center; gap:12px; min-width:340px;}
.lesson-left{font:900 20px/1.05 Arial, sans-serif; letter-spacing:.6px; text-transform:uppercase; white-space:nowrap;}
.bbtn-story{font:900 14px/1 Arial, sans-serif; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.10);}
.bbtn-story:hover{background:rgba(255,255,255,0.18);}
.banner-mid{display:flex; align-items:center; gap:10px;}
.btime{min-width:230px; text-align:center; font:900 14px/1 Arial, sans-serif; letter-spacing:.3px;}
.banner-right{margin-left:auto; display:flex; align-items:center; gap:10px;}
.product-right{font:900 32px/1 Arial, sans-serif; letter-spacing:1px; text-transform:uppercase; padding-left:10px; border-left:1px solid rgba(255,255,255,0.25);}
.legend-mini{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:rgba(0,0,0,0.18);}
.leg-mini-label{font:900 11px/1 Arial, sans-serif; opacity:.92; text-transform:uppercase; letter-spacing:.4px;}
.leg-mini-bar{display:inline-block; width:110px; height:10px; border-radius:6px; background: linear-gradient(90deg, #2b83ba, #4ecdc4, #a8e6a3, #ffd166, #ef476f); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18);}
.opacity-wrap{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:rgba(0,0,0,0.18);}
.op-label{font:900 11px/1 Arial, sans-serif; opacity:.92; text-transform:uppercase; letter-spacing:.4px;}
#radarOpacity{width:120px;}
.bstatus{margin-top:6px; font:800 12px/1 Arial, sans-serif; opacity:.9; max-width:95vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

/* Make story button obvious */
#beginStoryBtn{border-color: rgba(255,255,255,0.45);}
/* --- Driving question line (option 2 style) --- */
.dq-sub{margin-top:4px;font:800 14px/1 Arial,sans-serif;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dq-label{font-weight:900;opacity:.95}
.dq-text{font-weight:900;opacity:1}

/* --- Begin story: big + obvious (yellow) --- */
.bbtn-story{
  background:#fdd835 !important;
  color:#111 !important;
  border-color: rgba(0,0,0,0.35) !important;
  font:900 14px/1 Arial,sans-serif !important;
  padding:12px 14px !important;
  border-radius:14px !important;
  letter-spacing:.8px !important;
}
.bbtn-story:hover{filter:brightness(0.96)}

/* --- Product center --- */
.banner-product{display:flex;align-items:center;justify-content:center;min-width:240px}
.product-center{
  font:900 42px/1 Arial,sans-serif;
  letter-spacing:1px;
  text-transform:uppercase;
  padding:0 10px;
  white-space:nowrap;
}

/* Logo down a bit */
#brandLogo{bottom:6px !important; right:26px !important;}

/* --- Option-2 style driving question block --- */
.banner-left{display:flex;flex-direction:column;gap:2px;min-width:420px;max-width:44vw}
.lesson-left{font:900 24px/1 Arial,sans-serif;letter-spacing:.6px;text-transform:uppercase}
.dq-sub{font:800 14px/1.2 Arial,sans-serif;letter-spacing:.2px;text-transform:none;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dq-label{font-weight:900;text-transform:uppercase;letter-spacing:.5px}
.dq-text{font-weight:800}


/* Stack Begin Story above time controls */
.story-time-stack{display:flex;flex-direction:column;gap:8px;align-items:center;min-width:210px}
.banner-mid-stack{gap:10px}
/* Give the product a little breathing room */
.banner-product{margin:0 6px}


/* --- Banner alignment fix: pull legend/controls back up --- */
.banner-inner{align-items:flex-start}
.legend-mini{margin-top:0}
.opacity-wrap{margin-top:0}
.story-time-stack{margin-top:0}


/* --- Right-side controls pinned upper-right --- */
.right-controls{
  display:flex;
  align-items:center;
  gap:10px;
  margin-left:auto;
  margin-top:0;
}


/* --- Restore "like before" banner geometry --- */
.banner-inner{position:relative; align-items:center !important;}
.right-controls{
  position:absolute;
  top:10px;
  right:14px;
  margin-left:0 !important;
  align-items:center;
}
.legend-mini, .opacity-wrap{margin-top:0 !important;}
.story-time-stack{margin-top:0 !important;}

/* Logo lower */
#brandLogo{bottom:0px !important;}

/* --- Two-line banner layout --- */
.tvbanner{
  position:absolute; top:0; left:0; right:0;
  z-index:99999;
  background:rgba(11,28,45,0.90);
  color:#fff;
  border-bottom:2px solid rgba(255,255,255,0.12);
}
.banner-topline{
  display:flex;
  justify-content:center;
  padding:10px 14px 6px 14px;
  font-family: Arial, sans-serif;
  text-transform:uppercase;
  letter-spacing:.7px;
}
.topline-center{
  display:flex;
  align-items:baseline;
  gap:10px;
  max-width:1200px;
  width:100%;
  justify-content:center;
  flex-wrap:wrap;
}
.top-lesson{font-weight:900;font-size:26px;white-space:nowrap}
.top-sep{opacity:.65;font-weight:900}
.top-question{font-weight:800;font-size:16px;letter-spacing:.2px;text-transform:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.top-q-label{font-weight:900;text-transform:uppercase;letter-spacing:.6px}

.banner-bottomline{
  display:flex;
  justify-content:center;
  padding:6px 14px 10px 14px;
  font-family: Arial, sans-serif;
}
.bottomline-center{
  display:flex;
  align-items:center;
  gap:12px;
  width:100%;
  max-width:1200px;
  justify-content:center;
  flex-wrap:wrap;
}
/* Big product word, flexible */
.banner-product{min-width:200px;display:flex;justify-content:center}
.product-center{
  font:900 44px/1 Arial,sans-serif;
  letter-spacing:1px;
  text-transform:uppercase;
  white-space:nowrap;
}
.time-controls{display:flex;align-items:center;gap:10px}
.btime{font:900 16px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase;white-space:nowrap}

/* Begin button */
.bbtn-story{
  background:#fdd835 !important;
  color:#111 !important;
  border-color: rgba(0,0,0,0.35) !important;
  font:900 14px/1 Arial,sans-serif !important;
  padding:12px 16px !important;
  border-radius:14px !important;
  letter-spacing:.8px !important;
}

/* Opacity group */
.opacity-wrap{display:flex;align-items:center;gap:8px}
.op-label{font:900 12px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase}
#radarOpacity{width:180px}

/* Map legend near logo */
.map-legend{
  position:absolute;
  right:26px;
  bottom:92px;
  z-index:900;
  background:rgba(11,28,45,0.80);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:12px;
  padding:8px 10px;
  color:#fff;
  font-family: Arial, sans-serif;
}
.map-legend-row{display:flex;align-items:center;gap:10px}
.leg-mini-label{font:900 12px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase;opacity:.95}
.leg-mini-bar{
  width:140px;height:10px;border-radius:7px;
  background:linear-gradient(90deg,#2b83ba,#ffd166,#ef476f);
}

/* Keep logo low */
#brandLogo{bottom:0px !important; right:26px !important;}

/* --- Brand color stripes (from Weather Workshops logo) --- */
.tvbanner{ position:absolute; }
.tvbanner::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:4px;
  background:#2f4e94;
}
.tvbanner{position:absolute; top:0; left:0; right:0; z-index:99999; }


.banner-topline{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  padding:14px 14px 8px 14px;
  font-family: Arial, sans-serif;
  text-transform:uppercase;
  letter-spacing:.7px;
  position:relative;
}
.banner-topline .topline-center{
  flex:1;
  display:flex;
  align-items:baseline;
  gap:10px;
  max-width:1200px;
  justify-content:center;
  flex-wrap:wrap;
  padding-right:190px; /* reserve space so button doesn't overlap text */
}
.banner-topline .bbtn-story{
  position:absolute;
  right:14px;
  top:10px;
}


.banner-bottomline{padding:6px 14px 12px 14px;}


.map-legend{
  right:12px !important;
  bottom:70px !important;
  padding:7px 9px !important;
  border-radius:12px !important;
}
.leg-mini-bar{width:120px !important;}


#brandLogo{bottom:0px !important; right:14px !important;}


/* Pin START button in top-right of the top banner line */
.banner-topline{position:relative !important;}
.banner-topline > .bbtn-story{
  position:absolute !important;
  right:14px !important;
  top:10px !important;
}


/* Orange divider line in the middle (between top line and controls line) */
.banner-divider{
  height:3px;
  width:100%;
  background:#eab35b; /* brand orange */
  opacity:0.95;
}


/* Nudge legend tighter into the corner */
.map-legend{right:10px !important; bottom:62px !important;}


/* Center lesson/question text */
.topline-center{
  justify-content:center !important;
  text-align:center !important;
}

/* Force START button to upper-right corner */
.banner-topline{
  position:relative !important;
}
.banner-topline .bbtn-story{
  position:absolute !important;
  right:16px !important;
  top:50% !important;
  transform:translateY(-50%) !important;
}


/* --- FINAL banner alignment fixes --- */

/* True center for top line text */
.banner-topline{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
}
.banner-topline .topline-center{
  margin:0 auto !important;
  text-align:center !important;
  padding-right:0 !important;
}

/* Force START button to true upper-right corner */
.banner-topline .bbtn-story{
  position:absolute !important;
  right:16px !important;
  top:12px !important;
  transform:none !important;
}

/* Center RADAR on second row */
.banner-bottomline{
  display:flex !important;
  justify-content:center !important;
}
.banner-product{
  margin:0 auto !important;
}
.product-center{
  text-align:center !important;
}


/* --- Pin START button to upper-right (top line) --- */
.banner-topline{position:relative !important;}
.banner-topline #beginStoryBtn{
  position:absolute !important;
  right:16px !important;
  top:10px !important;
  transform:none !important;
}

/* --- Push logo slightly LOWER than the bottom edge (so it "sits lower") --- */
#brandLogo{
  bottom:-12px !important;
  right:10px !important;
}


/* Slightly tighter banner height (small) */
.banner-topline{padding-top:8px !important; padding-bottom:5px !important;}
.banner-bottomline{padding-top:3px !important; padding-bottom:7px !important;}

</style>
</head>

<body>
<div id="map"></div>
<div id="mapLegend" class="map-legend" title="Radar reflectivity">
  <div class="map-legend-row">
    <span class="leg-mini-label">Light</span>
    <span class="leg-mini-bar" aria-hidden="true"></span>
    <span class="leg-mini-label">Heavy</span>
  </div>
</div>
<div id="storyPanel" aria-label="Story panel">
  <div class="story-head">
    <div class="story-title" id="storyTitle">Story</div>
    <button class="story-close" id="storyCloseBtn" title="Close">✕</button>
  </div>
  <div class="story-body" id="storyBody">
    <p class="tiny">Loading story…</p>
  </div>
  <div class="story-nav">
    <button class="btn" id="storyPrevBtn">Back</button>
    <button class="btn" id="storyNextBtn">Next</button>
  </div>
  <div class="tiny" id="storyStep"></div>
</div>
<div id="banner" class="tvbanner">
  <div class="banner-topline" role="banner">
    <div class="topline-center">
      <span class="top-lesson">Lesson 1: Driving Question</span>
      <span class="top-sep">—</span>
      <span class="top-question"><span class="top-q-label">Question:</span> How can we use real-time weather data to make safer decisions?</span>
    </div>
    <button class="bbtn bbtn-story" id="beginStoryBtn" title="Begin the guided story">START</button>
  </div>
  <div class="banner-divider" aria-hidden="true"></div>

  <div class="banner-bottomline">
    <div class="bottomline-center">
<button class="bbtn" id="modeBtn" title="Toggle Student / Teacher mode">STUDENT</button>

      <div class="opacity-wrap" title="Radar opacity">
        <span class="op-label">Opacity</span>
        <input id="radarOpacity" type="range" min="20" max="100" value="70" />
      </div>

      <div class="banner-product" aria-label="Product shown">
        <div class="product-center" id="productLabel">RADAR</div>
      </div>

      <div class="time-controls" aria-label="Time controls">
        <button class="bbtn" id="bBackBtn" title="Back 3 hours">◀</button>
        <div class="btime" id="bannerTimeLabel">April 14, 2018 7AM</div>
        <button class="bbtn" id="bFwdBtn" title="Forward 3 hours">▶</button>
      </div>

      <button class="bbtn" id="zoomOutBtn" title="Zoom out">−</button>
      <button class="bbtn" id="zoomInBtn" title="Zoom in">+</button>
    </div>
  </div>

  <div id="status" class="bstatus" style="display:none;"></div>
</div>

<img id="brandLogo" src="./logo.png" alt="Weather Workshops" />
<script>
(function(){
  // ---------- Config ----------
  var STEP_HOURS = 3;

  // Use the same starting time as your case study controls:
  // 2018-04-14 12Z (7am Central daylight). We'll label it "CST" per your preference.
  var startZ = new Date(Date.UTC(2018, 3, 14, 12, 0, 0)); // months are 0-based; 3 = April
  var endZ   = new Date(Date.UTC(2018, 3, 15, 12, 0, 0)); // 24h window; extend later if you want
  var curZ = new Date(startZ.getTime());

  // Composite radar geographic extent (NAD83 geographic). Shifted ~60mi south + ~15mi east for better fit.
  // Base extent commonly used by IEM mosaics: lon -126..-66, lat 24..50
  var SHIFT_LAT = -1.09; // south shift (~15mi extra)   // south
  var SHIFT_LON = 0.49; // east shift (~15mi extra)   // east
  var RADAR_BOUNDS = L.latLngBounds(
    L.latLng(24 + SHIFT_LAT, -126 + SHIFT_LON),
    L.latLng(50 + SHIFT_LAT,  -66 + SHIFT_LON)
  );

  // Local file pattern in your repo:
  // radar_frames/n0q_201804141200.png, etc
  function pad2(n){ return (n<10?'0':'') + n; }
  function yyyymmdd(d){
    return d.getUTCFullYear() + pad2(d.getUTCMonth()+1) + pad2(d.getUTCDate());
  }
  function hhmm(d){
    return pad2(d.getUTCHours()) + pad2(d.getUTCMinutes());
  }
  function radarUrlFor(d){
    return "radar_frames/n0q_" + yyyymmdd(d) + hhmm(d) + ".png";
  }

  // Alerts file pattern you already have:
  // timeline_hourly/alerts_20180414_1500Z.geojson
  function alertsUrlFor(d){
    return "timeline_hourly/alerts_" + yyyymmdd(d) + "_" + pad2(d.getUTCHours()) + "00Z.geojson";
  }

  // "Central time" label (forced) — we just subtract 5 hours and show CST
  // (Technically CDT for April, but your students don't need DST complexity here.)
  function formatCentralLabel(d) {
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const m = months[d.getMonth()];
  const day = d.getDate();
  const year = d.getFullYear();
  let hr = d.getHours();
  const ampm = hr >= 12 ? "PM" : "AM";
  hr = hr % 12; if (hr === 0) hr = 12;
  // e.g. "Apr 14, 2018 7AM"
  return `${m} ${day}, ${year} ${hr}${ampm}`;
}

  // ---------- Map ----------
  var map = L.map("map", { zoomControl:true }).setView([43.55, -96.73], 6);
  var zl = document.getElementById("zoomLabel"); if (zl) zl.textContent = map.getZoom();
  // Thicker state boundaries (no labels)
  (function(){
    map.createPane("stateOutlinePane");
    map.getPane("stateOutlinePane").style.zIndex = 460;

    const outlineUrl = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/us-states.json";
    fetch(outlineUrl).then(r => r.json()).then(gj => {
      L.geoJSON(gj, {
        pane: "stateOutlinePane",
        interactive: false,
        style: { color: "#555", weight: 2.5, opacity: 0.7, fillOpacity: 0 }
      }).addTo(map);
    }).catch(()=>{/* ignore if offline */});
  })();


  // Clean base map (no labels)
  var base = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
    { attribution: "&copy; OpenStreetMap &copy; CARTO", subdomains:"abcd", maxZoom: 19 }
  ).addTo(map);

  // Optional labels (kept on top to help students)
  var labels = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png",
    { attribution: "", subdomains:"abcd", maxZoom: 19, pane: "overlayPane" }
  ).addTo(map);

  // Town labels
  function addTown(name, lat, lon){
    L.marker([lat, lon], {
      icon: L.divIcon({ className:"town-label", html: name, iconSize: null }),
      interactive:false
    }).addTo(map);
  }
  addTown("Sioux Falls", 43.55, -96.73);
  addTown("Rapid City", 44.0805, -103.2310);
  addTown("Denver", 39.7392, -104.9903);
  addTown("Omaha", 41.2565, -95.9345);
  addTown("Des Moines", 41.5868, -93.6250);
  addTown("Minneapolis", 44.9778, -93.2650);
  addTown("Kansas City", 39.0997, -94.5786);
  addTown("St. Louis", 38.6270, -90.1994);


  // ---------- Story (Google Sheet) ----------
  var SHEET_ID = "17Hzg7R2fSHJGbOKAKMqG4QAqA1GlSJwFM-SQwPhQObY";
  var SHEET_TAB = "April Blizzard Story";
  var storyItems = [];
  var storyMarkers = [];
  var storyIndex = 0;
  var focusRing = null;

  var storyPanel = document.getElementById("storyPanel");
  var storyTitleEl = document.getElementById("storyTitle");
  var storyBodyEl  = document.getElementById("storyBody");
  var storyStepEl  = document.getElementById("storyStep");

  function storyOpen(){
    if (!storyPanel) return; storyPanel.classList.add("story-open");
    var legendPop = document.getElementById("legendPop");
    if (legendPop) legendPop.classList.add("hidden");
    setTimeout(function(){ map.invalidateSize(); }, 220);
  }
  function storyClose(){
    if (!storyPanel) return; storyPanel.classList.remove("story-open");
    setTimeout(function(){ map.invalidateSize(); }, 220);
  }
  function storyToggle(){
    if (storyPanel.classList.contains("story-open")) storyClose();
    else if (storyStarted) { storyOpen(); }
  }

  function safeLink(url){
    if (!url) return "";
    return String(url).trim();
  }

  function renderStory(i, panTo){
    if (!storyItems.length) return;
    if (i < 0) i = 0;
    if (i >= storyItems.length) i = storyItems.length - 1;
    storyIndex = i;

    var item = storyItems[storyIndex];
    storyTitleEl.textContent = item.title || "Storm Story";

    var html = "";
    if (item.text) {
      // Convert newlines to paragraphs
      var parts = String(item.text).split(/\n+/).filter(Boolean);
      parts.forEach(function(p){ html += "<p>" + escapeHtml(p) + "</p>"; });
    } else {
      html += "<p class='tiny'>No text for this station yet.</p>";
    }

    var img = safeLink(item.image);
    var vid = safeLink(item.video);

    if (img) {
      html += "<div class='story-media'><img src='" + img + "' alt='Story image'></div>";
    }
    if (vid) {
      // Prefer embed links (youtube embed, vimeo embed, etc.)
      html += "<div class='story-media'><iframe src='" + vid + "' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe></div>";
    }

    storyBodyEl.innerHTML = html;
    storyStepEl.textContent = "Station " + (storyIndex + 1) + " of " + storyItems.length;

    // Highlight markers
    storyMarkers.forEach(function(m, idx){
      if (m && m.setStyle) {
        m.setStyle({
          radius: (idx===storyIndex? 12 : 8),
          opacity: 1,
          fillOpacity: (idx===storyIndex? 1 : 0.9),
          weight: (idx===storyIndex? 3 : 2)
        });
        if (idx===storyIndex && m.bringToFront) m.bringToFront();
      }
    });

    // Focus ring around the active station (helps guide attention)
    if (typeof item.lat === "number" && typeof item.lon === "number") {
      var ringRadiusM = 22000; // ~14 miles
      if (!focusRing) {
        focusRing = L.circle([item.lat, item.lon], {
          radius: ringRadiusM,
          color: "rgba(30,136,229,0.95)",
          weight: 2,
          opacity: 0.95,
          fill: false,
          dashArray: "6 6"
        }).addTo(map);
      } else {
        focusRing.setLatLng([item.lat, item.lon]);
        focusRing.setRadius(ringRadiusM);
      }
      if (focusRing.bringToFront) focusRing.bringToFront();
    }

    if (storyStarted) { storyOpen(); }

    if (panTo && item.lat != null && item.lon != null) {
      map.panTo([item.lat, item.lon], { animate:true });
    }
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function buildStoryMarkers(){
    // Remove existing
    storyMarkers.forEach(function(m){ try{ map.removeLayer(m); }catch(e){} });
    storyMarkers = [];

    storyItems.forEach(function(item, idx){
      if (typeof item.lat !== "number" || typeof item.lon !== "number") return;

      var m = L.circleMarker([item.lat, item.lon], {
        radius: 8,
        color: "rgba(255,255,255,0.95)",
        weight: 2,
        fillColor: "rgba(30,136,229,0.95)",
        fillOpacity: 0.9
      }).addTo(map);

      m.on("click", function(){
        renderStory(idx, false);
      });

      // Short hover tooltip
      if (item.title) {
        m.bindTooltip(item.title, { direction:"top", offset:[0,-8], opacity:0.9 });
      }

      storyMarkers.push(m);
    });

    // Initial highlight
    renderStory(0, false);
  }

  function loadStory(){
    var url = "https://opensheet.elk.sh/" + SHEET_ID + "/" + encodeURIComponent(SHEET_TAB);
    fetch(url).then(function(r){
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }).then(function(rows){
      // Normalize rows
      storyItems = (rows || []).map(function(r){
        var lat = parseFloat(r.lat);
        var lon = parseFloat(r.lon);
        return {
          id: r.id,
          title: r.title || "",
          text: r.text || "",
          lat: isFinite(lat) ? lat : null,
          lon: isFinite(lon) ? lon : null,
          image: r.image || "",
          video: r.video || "",
          order: parseFloat(r.order)
        };
      })
      .filter(function(x){ return x.title || x.text || (x.lat!=null && x.lon!=null); })
      .sort(function(a,b){
        var ao = isFinite(a.order) ? a.order : 9999;
        var bo = isFinite(b.order) ? b.order : 9999;
        return ao - bo;
      });

      if (!storyItems.length) {
        storyBodyEl.innerHTML = "<p class='tiny'>No rows found in your Google Sheet tab '" + SHEET_TAB + "'.</p>";
        return;
      }

      buildStoryMarkers();
      setStatus("Story: loaded " + storyItems.length + " stations");
    }).catch(function(err){
      storyBodyEl.innerHTML = "<p class='tiny'>Could not load story from Google Sheet. Check that the sheet is published, and the tab name is '" + SHEET_TAB + "'.</p>";
      setStatus("Story load failed");
    });
  }

  
// Banner actions
var beginStoryBtn = document.getElementById("beginStoryBtn");
if (beginStoryBtn) beginStoryBtn.onclick = function(){ storyStarted = true;
    renderStory(storyIndex, true); };

// Student/Teacher mode (Student hides layer toggles + status)
var modeBtn = document.getElementById("modeBtn");
function setMode(mode){
  if (mode === "teacher"){
    document.body.classList.remove("student-mode");
    if (modeBtn) modeBtn.textContent = "TEACHER";
  } else {
    document.body.classList.add("student-mode");
    if (modeBtn) modeBtn.textContent = "STUDENT";
  }
}
if (modeBtn){
  modeBtn.onclick = function(){
    var isStudent = document.body.classList.contains("student-mode");
    setMode(isStudent ? "teacher" : "student");
  };
}
// default to STUDENT mode
setMode("student");

// Radar opacity slider
var radarOpacity = document.getElementById("radarOpacity");
function applyRadarOpacity(){
  if (!radarOpacity) return;
  var v = parseInt(radarOpacity.value || "70", 10);
  var op = Math.max(0.2, Math.min(1, v/100));
  if (obsRadarOverlay && obsRadarEnabled) obsRadarOverlay.setOpacity(op);
}
if (radarOpacity){
  radarOpacity.oninput = applyRadarOpacity;
}

  // Story UI buttons

  
  var storyCloseBtn = document.getElementById("storyCloseBtn");
  if (storyCloseBtn) storyCloseBtn.onclick = storyClose;

  var prevBtn = document.getElementById("storyPrevBtn");
  var nextBtn = document.getElementById("storyNextBtn");
  if (prevBtn) prevBtn.onclick = function(){ renderStory(storyIndex - 1, true); };
  if (nextBtn) nextBtn.onclick = function(){ renderStory(storyIndex + 1, true); };

  // Load story now
  loadStory();


  map.on("zoomend", function(){
    var zl = document.getElementById("zoomLabel"); if (zl) zl.textContent = map.getZoom();
  });

  map.on("click", function(){
    var lp = document.getElementById("legendPop");
    if (lp) lp.classList.add("hidden");
  });

  // ---------- Layers ----------
  var obsRadarOverlay = null;
  var obsRadarEnabled = true;

  var alertsLayer = L.geoJSON(null, {
    filter: function(f){
      const p = (f && f.properties) ? f.properties : {};
      const ev = String(p.event || p.EVENT || p.headline || p.HEADLINE || "").toLowerCase();
      const phe = String(p.phenomena || p.PHENOM || p.phenom || "").toLowerCase();
      const sig = String(p.significance || p.SIG || p.sig || "").toLowerCase();

      // If we have human-readable event text, keep WARNINGS only
      if (ev){
        if (ev.includes("statement") || ev.includes("advisory") || ev.includes("watch")) return false;
        return ev.includes("warning");
      }

      // If data uses NWS-style codes, keep significance=W (warning)
      // Examples: phe=sv,to,ff,fl with sig=w
      if (sig === "w") return true;

      return false;
    },

    
    style: function(f){
      var p = (f && f.properties) ? f.properties : {};
      var ev = String(p.event || p.EVENT || p.headline || p.phenomena || "").toLowerCase();
      var phe = String(p.phenomena || p.PHENOM || "").toLowerCase();
      var sig = String(p.significance || p.SIG || "").toLowerCase();

      // Prefer explicit event text if present
      var key = ev || (phe && sig ? (phe + "." + sig) : phe || "");

      var stroke = "#333";
      var fill = "#333";

      var has = function(s){ return key.indexOf(s) !== -1; };

      // Core colors requested
      if (has("tornado") || phe==="to") { stroke = fill = "#e53935"; }          // red
      else if (has("severe thunderstorm") || phe==="sv") { stroke = fill = "#fdd835"; } // yellow
      else if (has("flash flood") || phe==="ff") { stroke = fill = "#00c853"; } // green
      else if (has("flood") || phe==="fl") { stroke = fill = "#00c853"; }       // green
      else { stroke = fill = "#42a5f5"; } // fallback blue

      return { color: stroke, weight: 2, opacity: 0.95, fillColor: fill, fillOpacity: 0.22 };
    },
    onEachFeature: function(f, layer){
      var props = f.properties || {};
      var title = props.event || props.EVENT || props.headline || props.HEADLINE || props.prod_type || props.phenomena || "Warning";
      layer.bindPopup("<b>" + String(title) + "</b>");
    }
  });
  alertsLayer.addTo(map);
  var alertsEnabled = true;

  // Layer control (NO extra base layer picker)
  // State boundary outline handled via GeoJSON (no labels)
var overlays = {};
  overlays["Composite Radar (Observed)"] = L.layerGroup(); // placeholder group
// We'll manage radar ourselves but still expose a checkbox
  var lc = L.control.layers(null, overlays, { collapsed:false }).addTo(map);

  // Remove any base-layer radio section if Leaflet created it empty
  setTimeout(function(){
    var el = document.querySelector(".leaflet-control-layers-base");
    if (el) el.style.display = "none";
  }, 50);

  // Toggle handler for layer control checkboxes
  map.on("overlayadd", function(e){

    if (e.name === "Composite Radar (Observed)") { obsRadarEnabled = true; updateRadar(); updateProductLabel(); }
  });
  map.on("overlayremove", function(e){

    if (e.name === "Composite Radar (Observed)") { obsRadarEnabled = false; if (obsRadarOverlay){ map.removeLayer(obsRadarOverlay); } updateProductLabel(); }
  });

  // Ensure radar checkbox starts ON
  // Leaflet doesn't automatically check our placeholder group, so we force it:
  (function forceRadarChecked(){
    var inputs = document.querySelectorAll(".leaflet-control-layers-overlays input");
    for (var i=0;i<inputs.length;i++){
      var label = inputs[i].parentElement && inputs[i].parentElement.textContent || "";
      if (label.indexOf("Composite Radar") !== -1){
        inputs[i].checked = true;
      }
    }
  })();

  // ---------- Updaters ----------
  function setStatus(s){ /* hidden */ }
  function setTimeLabel(){
    document.getElementById("bannerTimeLabel").textContent = formatCentralLabel(curZ);
  }

  function updateProductLabel(){
  var pl = document.getElementById("productLabel");
  if (!pl) return;
  pl.textContent = obsRadarEnabled ? "RADAR" : "MAP";
}

  function updateRadar(){
    if (!obsRadarEnabled) return;
    var url = radarUrlFor(curZ);

    // Test-load the image before swapping overlay (avoids blank overlay on 404)
    var img = new Image();
    img.onload = function(){
      if (obsRadarOverlay){ map.removeLayer(obsRadarOverlay); }
      var op = 0.70; var rs = document.getElementById("radarOpacity"); if (rs){ op = Math.max(0.2, Math.min(1, parseInt(rs.value||"70",10)/100)); }
      obsRadarOverlay = L.imageOverlay(url, RADAR_BOUNDS, { opacity: op, interactive:false });
      obsRadarOverlay.addTo(map);
      applyRadarOpacity();
      setStatus("Radar: " + url);
    };
    img.onerror = function(){
      setStatus("Radar missing: " + url + " (check /radar_frames/)");
    };
    img.src = url;
  }

  function updateAlerts(){
    
    var url = alertsUrlFor(curZ);
    fetch(url).then(function(r){
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }).then(function(gj){
      alertsLayer.clearLayers();
      alertsLayer.addData(gj);
      alertsLayer.addTo(map);
      setStatus("Alerts: " + url);
    }).catch(function(err){
      alertsLayer.clearLayers();
      setStatus("Alerts missing: " + url);
    });
  }

  function updateAll(){
    setTimeLabel();
    updateRadar();
    updateAlerts();
  }

  // ---------- Time controls ----------
  function clampTime(){
    if (curZ < startZ) curZ = new Date(startZ.getTime());
    if (curZ > endZ) curZ = new Date(endZ.getTime());
  }

  document.getElementById('bBackBtn').onclick = function(){
    curZ = new Date(curZ.getTime() - STEP_HOURS*3600*1000);
    clampTime(); updateAll();
  };
  document.getElementById('bFwdBtn').onclick = function(){
    curZ = new Date(curZ.getTime() + STEP_HOURS*3600*1000);
    clampTime(); updateAll();
  };

  const zIn = document.getElementById("zoomInBtn");
  const zOut = document.getElementById("zoomOutBtn");
  if (zIn) zIn.onclick = () => map.zoomIn();
  if (zOut) zOut.onclick = () => map.zoomOut();


  // Initial
  setTimeLabel();
  // Add overlays based on default checkboxes
  // Alerts starts OFF; radar starts ON.
  updateAll();

})();
</script>
</body>
</html>
